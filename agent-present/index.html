<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Present</title>
    <script src="https://unpkg.com/cobrowse-agent-sdk@2.14.0/dist/umd-browser/cobrowse-agent-sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jose/4.15.2/index.umd.min.js"></script>
    <script src="https://js.cobrowse.io/CobrowseIO.js"></script>
</head>

<body>

    <script>
        const licenseKey = '<YOUR_LICENSE_KEY>'
        const agentToken = '<AGENT_TOKEN>'
        const alg = 'RS256'

        // WE DO NOT RECOMMEND COMMITING YOUR PRIVATE KEY. THIS IS ONLY FOR DEMO PURPOSES.
        // Replace with your private key in PKCS8 format
        const pkcs8 = `-----BEGIN PRIVATE KEY-----
        MIIJQQIBADANBgkqhkiR9w0BAQEFAASCCSswggknAgEAAoLLAQDmJ057nvWWpiTU
        utfRCVYPSBYvtf0bRVso7o1B8tcecKNzYAYBD4cWekliW3+3XNGUdWvENpKYfhxp
        ...
        QXSU+SGTKsVjPZtEP4exydgTrXMx
        -----END PRIVATE KEY-----`

        const cobrowse = new CobrowseAPI(agentToken);

        var session

        const createPresentSession = async () => {
            // Create a new session with full device in requesting state
            session = await cobrowse.sessions.create({ full_device: 'requested', agent: 'me' })

            const privateKey = await jose.importPKCS8(pkcs8, alg)
            const viewerToken = await generateViewerJWT(privateKey, licenseKey, session.id)

            // Generate the present URL for the session with the viewer token including all query parameters to hide agent tools from the viewer
            const presentURL = `https://cobrowse.io/session/${session.id}?token=${viewerToken}&agent_tools=none&device_controls=none&end_action=none&popout=none&session_details=none`
            document.getElementById('present-url').value = presentURL
        }

        const startPresentSession = async () => {
            const media = await navigator.mediaDevices.getDisplayMedia({
                video: {
                    cursor: 'always',
                    width: { ideal: 1400 },
                    height: { ideal: 1000 },
                    frameRate: { max: 10 }
                },
                audio: false
            })

            const video = document.getElementById('preview')
            video.srcObject = media
            video.play()

            await CobrowseIO.client()

            CobrowseIO.license = licenseKey
            CobrowseIO.redactedViews = ['.container']
            CobrowseIO.capabilities = ['full_device']
            CobrowseIO.showSessionControls = () => { }
            CobrowseIO.hideSessionControls = () => { }
            CobrowseIO.confirmSession = async () => true
            CobrowseIO.confirmFullDevice = async () => media
            CobrowseIO.confirmRemoteControl = async () => false

            CobrowseIO.on('session.updated', presentSession => {
                if (presentSession.isActive()) {
                    document.getElementById('share-button').style.display = 'none'
                    document.getElementById('end-button').style.display = 'block'
                    document.getElementById('preview').style.display = 'block'

                    if (!presentSession.fullDevice()) {
                        session.end()
                    }
                }
            })

            CobrowseIO.on('session.ended', async presentSession => {
                if (media) media.getTracks().forEach(track => track.stop())
                resetPresentSession();
            });

            trackSessionParticipants()

            await CobrowseIO.start({ allowIFrameStart: true, register: false })

            // Use the Client SDK to join the session
            await CobrowseIO.getSession(session.id)
        }

        const resetPresentSession = async () => {

            await CobrowseIO.stop()

            document.getElementById('share-button').style.display = 'block'
            document.getElementById('end-button').style.display = 'none'
            document.getElementById('preview').style.display = 'none'

            await createPresentSession();
        }

        const trackSessionParticipants = async () => {
            // Track who has already joined the session
            const knownParticipants = {}

            // Do not notify when the presenter joins the session
            const presenter = await cobrowse.users.get('me')
            knownParticipants[presenter.id] = presenter

            // If the presenter refreshes the page, we need to ignore participants
            // who have already viewed the session to prevent double notifications
            CobrowseIO.on('session.loaded', sess => {
                for (const participant of sess.agents()) {
                    knownParticipants[participant.id] = participant
                }
            })

            // Notify when someone new views the session
            CobrowseIO.on('session.updated', sess => {
                for (const participant of sess.agents()) {
                    if ( knownParticipants[participant.id] ) continue
                    knownParticipants[participant.id] = participant

                    // This is the first time that we have seen this participant
                    handleNewParticipant(participant)
                }
            })
        }

        const generateViewerJWT = async (privateKey, license, id) => {
            // Generate a viewer JWT token scoped to a single session
            const jwt = await new jose.SignJWT({
                displayName: "Viewer",
                role: null,
                policy: {
                    version: 2,
                    sessions: {
                        id: id,
                        // a further check can be added by filtering by agent id
                        // agent: jose.decodeJwt(agentToken).payload.id
                    }
                }
            })
            .setProtectedHeader({ alg })
            .setIssuedAt()
            .setIssuer(licenseKey)
            .setSubject('viewer@cobrowse.io')
            .setAudience('https://cobrowse.io')
            .setExpirationTime('30m') // Choose your own expiration time
            .sign(privateKey)

            return jwt
        }

        // A basic class to provide notifications during the session
        class Toast {
            constructor(container) {
                const toastContainer = document.createElement('div')
                toastContainer.className = 'toasts'
                this.container = toastContainer
                container.appendChild(toastContainer)

                this.exitAnimationDuration = 550
                this.toastDuration = 2000
            }

            notify(message) {
                const toast = document.createElement('div')
                toast.className = 'toast'
                toast.classList.add('fadeinup')
                toast.textContent = message
                this.container.appendChild(toast)

                setTimeout(() => {
                    toast.classList.add('fadeoutdown')

                    setTimeout(() => {
                        this.container.removeChild(toast);
                    }, this.exitAnimationDuration)
                }, this.toastDuration)
            }
        }

        let toast
        const handleNewParticipant = (participant) => {
            if (!toast) toast = new Toast(document.querySelector('.panel'))
            toast.notify(`${participant.name || 'A customer'} has joined the session`)
        }

        (async () => {
            // On load create a new present session
            await createPresentSession()
        })();
    </script>

    <div class="container">
        <div class="panel">
            <input id="present-url">
            <button id="share-button" onclick="startPresentSession()">Share my Desktop</button>
            <button id="end-button" onclick="resetPresentSession()">End present session</button>
            <video id="preview"></video>
        </div>
    </div>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        .container {
            max-width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        .panel {
            background-color: #ffffff;
            width: 80%;
            max-width: 700px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #present-url {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #share-button,
        #end-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #share-button:hover,
        #end-button:hover {
            background-color: #0056b3;
        }

        #end-button {
            display: none;
        }

        #preview {
            width: 100%;
            height: auto;
            margin-top: 20px;
            overflow: hidden;
            display: none;
            border: 1px solid #ccc;
        }

        .toasts {
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            padding: 20px;
            height: 100%;
            width: 100%;
            pointer-events: none;
            z-index: 9999;

            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
        }

        .toast {
            box-sizing: border-box;
            position: relative;
            display: block;
            overflow: hidden;
            flex-shrink: 0;
            pointer-events: auto;

            max-width: 300px;
            text-align: center;
            padding: 8px 15px;
            margin-top: 20px;

            border-radius: 2px;
            box-shadow: 0px 3px 7px 0px rgba(0, 0, 0, 0.25);

            color: #fff;
            background: rgb(101 86 240);
        }

        @keyframes fadeinup{
          0%{
            opacity: 0;
            transform: translateY(25%);
          }
          100%{
            opacity: 1;
            transform: translateY(0);
          }
        }

        @keyframes fadeoutdown{
          0%{
            opacity: 1;
            transform: translateY(0);
          }
          100%{
            opacity: 0;
            transform: translateY(25%);
          }
        }

        .fadeinup {
            display: block;
            animation: fadeinup 0.3s ease-in forwards;
            transform: translateY(25%);
        }

        .fadeoutdown {
            transform: translateY(0);
            animation: fadeoutdown 0.3s forwards;
            animation-delay: 0.25s;
        }
    </style>
</body>

</html>
